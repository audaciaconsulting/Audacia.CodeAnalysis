# Audacia.CodeAnalysis

The `Audacia.CodeAnalysis` repository contains .NET analyzers and rulesets to provide checks on Audacia's coding standards.

## Getting started

There are three analyzer packages available:
- A standard package
- A package with extra analyzers specifically for ASP.NET Core projects
- A package with extra analyzers specifically for Entity Framework Core projects

Which one you install depends on the type of project you're working on.

Once you've installed the `Audacia.CodeAnalysis`, `Audacia.CodeAnalysis.AspNetCore` or `Audacia.CodeAnalysis.EntityFrameworkCore` package you need to get one or more rulesets. The rulesets are provided as `.editorconfig` files. `.editorconfig` files should generally be located at the root of your repo or solution, however they can be located anywhere in the folder hierarchy, and the file closest a particular code file will be used. See [here](https://docs.microsoft.com/en-us/visualstudio/ide/create-portable-custom-editor-options?view=vs-2019#file-hierarchy-and-precedence) for more information.

The [Base](https://github.com/audaciaconsulting/Audacia.CodeAnalysis/blob/master/dotnet-roslyn/config/Audacia.CodeAnalysis/Base/.editorconfig) ruleset should be used by every project/solution as it contains the full set of rules with default severities. This should be added to the root of your repo/solution, i.e. in the same location as your .sln file.

If you have a specific kind of project that falls into one of the categories below then you should include the relevant `.editorconfig` file in your project folder (or a sub-folder in some cases) to override some rules:

- [Tests](https://github.com/audaciaconsulting/Audacia.CodeAnalysis/blob/master/dotnet-roslyn/config/Audacia.CodeAnalysis/Tests/.editorconfig):
    - This ruleset relaxes certain rules in the general configuration specifically to allow for patterns commonly used in tests such as public nested classes and underscores in names.

- [Libraries](https://github.com/audaciaconsulting/Audacia.CodeAnalysis/blob/master/dotnet-roslyn/config/Audacia.CodeAnalysis/Libraries/.editorconfig):
    - This ruleset changes the severity of certain rules in the general configuration specifically for use in libraries, for example to enforce stricter rules around documentation.

- [AspNetCore](https://github.com/audaciaconsulting/Audacia.CodeAnalysis/blob/master/dotnet-roslyn/config/Audacia.CodeAnalysis.AspNetCore/.editorconfig): See the [Audacia.CodeAnalysis.AspNetCore](https://github.com/audaciaconsulting/Audacia.CodeAnalysis/blob/master/dotnet-roslyn/config/Audacia.CodeAnalysis.AspNetCore/README.md) project for more information.

- Entity Framework and Entity Framework Core have several specific configs:
    - [Entity Framework Core](https://github.com/audaciaconsulting/Audacia.CodeAnalysis/blob/master/dotnet-roslyn/config/Audacia.CodeAnalysis.EntityFrameworkCore/.editorconfig) has some rules specific to EF Core: See the [Audacia.CodeAnalysis.EntityFrameworkCore](https://github.com/audaciaconsulting/Audacia.CodeAnalysis/blob/master/dotnet-roslyn/config/Audacia.CodeAnalysis.EntityFrameworkCore/README.md) project for more information.
    - Migrations can be ignored by the analyzer as it is code generated by Entity Framework; [this .editorconfig](https://github.com/audaciaconsulting/Audacia.CodeAnalysis/blob/master/dotnet-roslyn/config/Audacia.CodeAnalysis/EntityFramework/Migrations/.editorconfig) can be added to the Migrations folder to prevent code being analyzed.
    - Some rules do not apply to Entity Framework model configuration code; [this .editorconfig](https://github.com/audaciaconsulting/Audacia.CodeAnalysis/blob/master/dotnet-roslyn/config/Audacia.CodeAnalysis/EntityFramework/ModelConfiguration/.editorconfig) can be added to the appropriate folder to suppress these rules.

Finally, clean and rebuild your solution (it may take a while first time round). You will probably notice a lot of inspection warnings that were not present before.

### .NET Framework Projects

When installing the `Audacia.CodeAnalysis` NuGet package in .NET Framework projects you may need to do using package manager console with the `-IncludePreRelease` argument specified explicitly. This is because some of the analyzers referenced are pre-release packages and .NET Framework seems to need you to opt-in to such packages.

## IDE Support

You must be using Visual Studio version 17.0+ (Visual Studio 2022) or Rider version 2021.3.2+.

### Rider Support
Rider doesn't fully support custom settings in .editorconfig. This issue has been raised with JetBrains (see [here](https://youtrack.jetbrains.com/issue/RIDER-53508)), but in the meantime a workaround is documented
[here](https://dev.azure.com/audacia/Audacia/_git/Audacia.CodeAnalysis?path=/dotnet-roslyn/analyzers/Audacia.CodeAnalysis.Analyzers/README.md&anchor=custom-.editorconfig-settings-in-rider&_a=preview).

 ##################### The above link does not seem to have an equivalent in Github. ######################

There are a few rules that Rider's code analysis doesn't pick up, for example CA1033, CA1008 and AV1715. This issue has also been raised with JetBrains (see [here](https://youtrack.jetbrains.com/issue/RIDER-53376)).

## Including Microsoft Code Style Rules in Build

By default, Microsoft's code style rules (prefixed `IDE`) don't get run during a build: they just run in the IDE itself. To include these code style rules in a build you must add the following to your .csproj file:
```xml
<EnforceCodeStyleInBuild>true</EnforceCodeStyleInBuild>
```

## Excluding Generated Code

It's usually a good idea to exclude generated code from analysis, as you may not have control over the code generation process which can lead to unresolvable violations.

If generated code is all located in a particular directory, you can place an .editorconfig file in the root of that directory and it will exclude all source code files from analysis.

The .editorconfig file should look something like this:
```
# EF Migration Rules
# Description: Ruleset to disable all analysis on EF Migration classes

# Code files
[*.cs]

generated_code = true
```

## Configuring Warnings As Errors

Add the following to your project's `.csproj` file to make the compiler treat warnings as errors, and stop compilation when a warning is raised:

```xml
<TreatWarningsAsErrors>true</TreatWarningsAsErrors>
```

You can configure treating warnings as errors for specific warnings as follows:

```xml
<WarningsAsErrors>ACL1005,CS0168</WarningsAsErrors>
<WarningsNotAsErrors>ACL1006,CS0167</WarningsNotAsErrors>
```

To see warnings as errors for a single compilation without changing your `.csproj`, pass in the `--warnaserror` to `dotnet build`.

## More Information on Analyzers

The analyzers used come from a variety of sources.

### Audacia Custom Analyzers

Audacia has a set of custom analyzers. See [here](https://github.com/audaciaconsulting/Audacia.CodeAnalysis/blob/master/dotnet-roslyn/analyzers/Audacia.CodeAnalysis.Analyzers/README.md) for more information.

All rules are prefixed `ACL`.

### CSharpGuidelinesAnalyzer

The [CSharpGuidelinesAnalyzer](https://github.com/bkoelman/CSharpGuidelinesAnalyzer) implements analyzers for the C# guidelines (found [here](https://csharpcodingguidelines.com/)) that, for a long time have been the basis of Audacia's C# coding standards.

All rules are prefixed `AV`.

### Roslynator

The [Roslynator](https://github.com/JosefPihrt/Roslynator) project is a large collection of analyzers covering most areas of C# code.

All rules are prefixed `RCS`.

### Microsoft Analyzers

Microsoft provide a number of analyzers for checking best practice C# and .NET usage. There are [quality rules](https://docs.microsoft.com/en-us/dotnet/fundamentals/code-analysis/quality-rules/) and [style rules](https://docs.microsoft.com/en-us/dotnet/fundamentals/code-analysis/style-rules/). The [Roslyn analyzers GitHub repo](https://github.com/dotnet/roslyn-analyzers) has more information.

Code quality rules are prefixed `CA` and code style rules are prefixed `IDE`.

### StyleCop

[StyleCop](https://github.com/DotNetAnalyzers/StyleCopAnalyzers) provides analyzers for checking formatting, naming, layout and other related areas.

All rules are prefixed `SA`.

### ReflectionAnalyzers

[ReflectionAnalyzers](https://github.com/DotNetAnalyzers/ReflectionAnalyzers) provides analyzers for checking correct usage of reflection in C# code.

All rules are prefixed `REFL`.

** Note the ReflectionAnalyzers package has been temporarily removed from Audacia.CodeAnalysis as the release of Visual Studio 2022 (with the latest version of Roslyn) has caused errors when loading the analyzers. This is being tracked by [this GitHub issue](https://github.com/GuOrg/Gu.Analyzers/issues/315) and the package will be re-added when the issue is resolved. **

### IDisposableAnalyzers

[IDisposableAnalyzers](https://github.com/DotNetAnalyzers/IDisposableAnalyzers) provides analyzers for checking correct usage of `IDisposable` in C# code.

All rules are prefixed `IDISP`.

### DocumentationAnalyzers

[DocumentationAnalyzers](https://github.com/DotNetAnalyzers/DocumentationAnalyzers) provides analyzers for checking correct usage in documentation.

All rules are prefixed with `DOC`.

### Entity Framework Core Analyzers

[Microsoft.EntityFrameworkCore.Analyzers](https://github.com/dotnet/efcore/tree/main/src/EFCore.Analyzers) provides C# analyzers for Entity Framework Core.

All rules are prefixed `EF`.